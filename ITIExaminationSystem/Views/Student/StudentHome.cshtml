@using System.Text.Json
@model Student
@{
    Layout = null;

    var jsonOptions = new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                WriteIndented = false
            };
    var coursesJson = JsonSerializer.Serialize(ViewBag.Courses ?? new List<object>(), jsonOptions);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITI Student Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/studentHome.css"/>
</head>
<body>
    <div class="top-nav">
        <div class="logo-section">
            <div class="logo pulse">ITI</div>
            <span class="portal-title">Student Portal</span>
        </div>
        <div class="user-section">
            <div class="user-info">
                <div class="user-name">@Model.User.UserName</div>
                <div class="user-role">Student ID: @Model.StudentId</div>
            </div>
            <a class="logout-btn" asp-action="LoginPage" asp-controller="Home">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <div id="dashboard" class="container">
        <div class="student-info-card">
            <div class="student-info-grid">
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-user"></i> Student Name</div>
                    <div class="info-value">@Model.User.UserName</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-graduation-cap"></i> Track</div>
                    <div class="info-value">@ViewBag.Track.TrackName</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-building"></i> Branch</div>
                    <div class="info-value">@ViewBag.Branch.BranchName</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-calendar-alt"></i> Academic Year</div>
                    <div class="info-value">2024/2025</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon courses"><i class="fas fa-book"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Enrolled Courses</div>
                    <div class="stat-value">@ViewBag.TrackCourses</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon exams"><i class="fas fa-file-alt"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Total Exams</div>
                    <div class="stat-value">@ViewBag.TotalExams</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon completed"><i class="fas fa-check-circle"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@ViewBag.CompletedExams</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon content"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Modules</div>
                    <div class="stat-value">@ViewBag.TotalModules</div>
                </div>
            </div>
        </div>

        <h2 class="section-title">My Courses</h2>

        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="courseSearch" class="search-input"
                       placeholder="Search courses by name, code, or instructor..." />
            </div>
            <div class="search-results" id="searchResults">
                Showing all @(ViewBag.Courses?.Count ?? 0) courses
            </div>
        </div>

        <div class="courses-grid" id="coursesGrid">
            @if (ViewBag.Courses != null && ViewBag.Courses.Count > 0)
            {
                foreach (var course in ViewBag.Courses)
                {
                    var badgeColor = "linear-gradient(135deg, var(--primary), var(--accent))";
                    if (course.Status == "COMPLETED") { badgeColor = "linear-gradient(135deg, var(--success), #27ae60)"; }
                    else if (course.Status == "UPCOMING") { badgeColor = "linear-gradient(135deg, var(--warning), #e67e22)"; }

                    <div class="course-card"
                         data-course-id="@course.Id"
                         data-course-title="@course.Title.ToLower()"
                         data-course-code="@course.Code.ToString().ToLower()"
                         data-course-instructor="@course.Instructor.ToLower()"
                         onclick="openCourseModal(@course.Id)">
                        <div class="course-header">
                            <div>
                                <div class="course-title">@course.Title</div>
                                <div class="course-code">@course.Code</div>
                            </div>
                            <div class="course-badge" style="background: @badgeColor;">@course.Status</div>
                        </div>
                        <div class="course-footer">
                            <div class="course-instructor">
                                <i class="fas fa-user-tie"></i> @course.Instructor
                            </div>
                            <div class="course-stats">
                                <div class="course-stat-item">
                                    <div class="course-stat-value">@course.Modules</div>
                                    <div class="course-stat-label">Modules</div>
                                </div>
                                <div class="course-stat-item">
                                    <div class="course-stat-value">@course.Exams</div>
                                    <div class="course-stat-label">Exams</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    <h3>No courses available</h3>
                    <p>You are not enrolled in any courses yet.</p>
                </div>
            }
        </div>
    </div>

    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Course Details</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="fab" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></div>

    <script>
        // ============================================================
        // FIXED: Use pre-serialized JSON from C#
        // ============================================================
        const coursesData = {};
        const rawData = @(Html.Raw(coursesJson));

        if (rawData && Array.isArray(rawData)) {
            rawData.forEach(c => {
                coursesData[c.id] = c;
            });
        }

        console.log("✅ Courses Loaded:", Object.keys(coursesData).length, "courses");

        function setupSearch() {
            const searchInput = document.getElementById('courseSearch');
            const searchResults = document.getElementById('searchResults');
            const totalCourses = Object.keys(coursesData).length;

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const allCards = document.querySelectorAll('.course-card');
                let visibleCount = 0;

                allCards.forEach(card => {
                    const title = card.dataset.courseTitle;
                    const code = card.dataset.courseCode;
                    const instructor = card.dataset.courseInstructor;
                    const matches = title.includes(searchTerm) ||
                                   code.includes(searchTerm) ||
                                   instructor.includes(searchTerm);

                    if (matches || searchTerm === '') {
                        card.style.display = 'flex';
                        card.style.animation = 'fadeInUp 0.4s ease';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                updateSearchResults(visibleCount);
            });

            // Add focus effect
            searchInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
            });

            searchInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        }

        function updateSearchResults(count) {
            const resultsElement = document.getElementById('searchResults');
            const totalCourses = Object.keys(coursesData).length;

            if (count === totalCourses) {
                resultsElement.textContent = `Showing all ${totalCourses} courses`;
                resultsElement.style.background = 'rgba(67, 97, 238, 0.1)';
                resultsElement.style.color = 'var(--primary)';
            } else if (count === 0) {
                resultsElement.textContent = 'No courses found. Try a different search.';
                resultsElement.style.background = 'rgba(231, 76, 60, 0.1)';
                resultsElement.style.color = 'var(--danger)';
            } else {
                resultsElement.textContent = `Found ${count} of ${totalCourses} courses`;
                resultsElement.style.background = 'rgba(52, 152, 219, 0.1)';
                resultsElement.style.color = 'var(--info)';
            }
        }

        function openCourseModal(courseId) {
            console.log('Opening modal for course ID:', courseId);
            const course = coursesData[courseId];

            if (!course) {
                console.error('❌ Course not found!', courseId);
                showNotification('Course not found!', 'error');
                return;
            }

            document.getElementById('modalTitle').textContent = `${course.title} (${course.code})`;

            const contentHtml = generateContentHtml(course);
            const examsHtml = generateExamsHtml(course);

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="modal-tabs">
                    <button class="tab-btn active" data-tab="content">
                        <i class="fas fa-list"></i> Course Overview
                    </button>
                    <button class="tab-btn" data-tab="examinations">
                        <i class="fas fa-file-alt"></i> Examinations
                    </button>
                </div>
                <div class="tab-content">
                    <div id="content-tab" class="tab-pane active">${contentHtml}</div>
                    <div id="examinations-tab" class="tab-pane">${examsHtml}</div>
                </div>
            `;

            // Set up event listeners for the tabs
            setupTabListeners();

            document.getElementById('courseModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function setupTabListeners() {
            // Add click event to all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update active tab pane
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
                if (pane.id === `${tabName}-tab`) {
                    pane.classList.add('active');
                }
            });
        }

        function generateContentHtml(course) {
            let html = '<div class="content-section">';

            html += `
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-value">${course.modules || 0}</div>
                        <div class="summary-label">Modules</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-value">${course.exams || 0}</div>
                        <div class="summary-label">Exams</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-value">${course.completed || 0}</div>
                        <div class="summary-label">Completed</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-value">${(course.exams || 0) - (course.completed || 0)}</div>
                        <div class="summary-label">Upcoming</div>
                    </div>
                </div>
            `;

            if (course.description && course.description.trim() !== '') {
                html += `
                    <div style="margin: 30px 0;">
                        <h3 style="color: var(--dark); margin-bottom: 15px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: var(--primary);"></i> Course Description
                        </h3>
                        <div style="background: rgba(67, 97, 238, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
                            <p style="color: var(--dark); line-height: 1.6;">${escapeHtml(course.description)}</p>
                        </div>
                    </div>
                `;
            }

            if (course.topics && course.topics.length > 0) {
                html += `
                    <h3 style="color: var(--dark); margin: 30px 0 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-bookmark" style="color: var(--primary);"></i> Course Modules
                    </h3>
                    <div class="headlines-list">`;

                course.topics.forEach((topic, index) => {
                    html += `
                        <div class="headline-item">
                            <div class="headline-number">${index + 1}</div>
                            <div class="headline-text">${escapeHtml(topic)}</div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function generateExamsHtml(course) {
            if (!course.examList || course.examList.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px 20px; color: var(--gray);">
                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3 style="margin-bottom: 10px; color: var(--dark);">No exams available</h3>
                        <p>There are no exams scheduled for this course yet.</p>
                    </div>
                `;
            }

            const completedExams = course.examList.filter(e => e.isCompleted);
            const scheduledExams = course.examList.filter(e => !e.isCompleted);
            let html = "";

            if (completedExams.length > 0) {
                html += '<h3 style="color: var(--dark); margin-bottom: 25px; font-size: 1.5rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-check-circle" style="color: var(--success);"></i> Completed Exams</h3>';
                completedExams.forEach((exam) => {
                    const percentage = exam.totalScore ? Math.round((exam.score || 0) / exam.totalScore * 100) : 0;
                    html += `
                        <div class="exam-item">
                            <div class="exam-item-header">
                                <div class="exam-name">${escapeHtml(exam.name || `Exam ${exam.id}`)}</div>
                                <div class="exam-type">${escapeHtml(exam.type || 'Exam')}</div>
                            </div>
                            <div class="exam-details">
                                <div class="exam-detail-item">
                                    <i class="fas fa-calendar"></i> ${exam.date || 'Not scheduled'}
                                </div>
                                <div class="exam-detail-item">
                                    <i class="fas fa-clock"></i> ${exam.duration || 'N/A'} minutes
                                </div>
                                <div class="exam-detail-item">
                                    <i class="fas fa-question-circle"></i> ${exam.questions || 'N/A'} Questions
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px; margin-top: 20px;">
                                <span class="exam-score">
                                    <i class="fas fa-star"></i> Score: ${exam.score || 0}/${exam.totalScore || 100}
                                </span>
                                <span style="font-size: 0.9rem; color: var(--gray);">
                                    (${percentage}%)
                                </span>
                            </div>
                        </div>
                    `;
                });
            }

            if (scheduledExams.length > 0) {
                if (completedExams.length > 0) {
                    html += '<div style="margin-top: 40px;"></div>';
                }
                html += '<h3 style="color: var(--dark); margin: 40px 0 25px; font-size: 1.5rem; display: flex; align-items: center; gap: 12px;"><i class="fas fa-calendar-check" style="color: var(--warning);"></i> Scheduled Exams</h3>';
                scheduledExams.forEach((exam) => {
                    html += `
                        <div class="exam-item">
                            <div class="exam-item-header">
                                <div class="exam-name">${escapeHtml(exam.name || `Exam ${exam.id}`)}</div>
                                <div class="exam-type">${escapeHtml(exam.type || 'Exam')}</div>
                            </div>
                            <div class="exam-details">
                                <div class="exam-detail-item">
                                    <i class="fas fa-calendar"></i> ${exam.date || 'Not scheduled'}
                                </div>
                                <div class="exam-detail-item">
                                    <i class="fas fa-clock"></i> ${exam.duration || 'N/A'} minutes
                                </div>
                                <div class="exam-detail-item">
                                    <i class="fas fa-question-circle"></i> ${exam.questions || 'N/A'} Questions
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px; margin-top: 20px;">
                                <span class="exam-status ${exam.available ? "status-available" : "status-upcoming"}">
                                    <i class="fas ${exam.available ? "fa-check-circle" : "fa-hourglass-half"}"></i>
                                    ${exam.available ? "Available Now" : "Not Available Yet"}
                                </span>
                                ${exam.available
                                    ? `<a href="/exam/start?examId=${exam.id}" class="exam-btn">
                                          <i class="fas fa-play-circle"></i> Start Exam
                                      </a>`
                                    : `<button class="exam-btn" disabled>
                                          <i class="fas fa-lock"></i> Coming Soon
                                      </button>`
                                }
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        function closeModal() {
            document.getElementById("courseModal").classList.remove("active");
            document.body.style.overflow = 'auto';
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)'};
                color: white;
                border-radius: 12px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                transform: translateX(150%);
                transition: transform 0.3s ease;
            `;

            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                <span>${escapeHtml(message)}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupSearch();

            // Add animation delay to stat cards
            document.querySelectorAll('.stat-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });

            // Add animation delay to course cards
            document.querySelectorAll('.course-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.05}s`;
            });
        });

        window.onclick = function(event) {
            const modal = document.getElementById('courseModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Smooth scroll behavior for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });
    </script>
</body>
</html>