@using System.Text.Json
@using ITIExaminationSystem.Models.ModelView ;
@model TakeExamViewModel

@{
    Layout = null;
    
    // Fix: Configure JSON to use CamelCase so JavaScript can read it (QuestionList -> questionList)
    var jsonOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };
    var modelJson = JsonSerializer.Serialize(Model, jsonOptions);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="~/images/Gemini_Generated_Image_vi5243vi5243vi52.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Model.Name - Exam</title>

    <link rel="stylesheet" href="~/css/Exam.css" asp-append-version="true" />
</head>
<body>
    <div class="bg-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>
    <div class="container">
        <div class="exam-header">
            <h1 class="exam-title">@Model.Name</h1>
            <div class="exam-info">
                <div class="exam-info-item">
                    <span>⏱️</span>
                    <span>Duration: @Model.Duration minutes</span>
                </div>
                <div class="exam-info-item">
                    <span>📝</span>
                    <span>Questions: @Model.QuestionList.Count</span>
                </div>
                <div class="exam-info-item">
                    <span>🎯</span>
                    <span>Total Score: @Model.TotalScore</span>
                </div>
            </div>
        </div>

        <div class="timer-container">
            <span class="timer-label">Time Remaining</span>
            <span class="timer-value" id="timer">@(Model.Duration):00</span>
        </div>

        <div class="exam-stats-dashboard">
            <div class="stat-item">
                <span class="stat-label">Solved</span>
                <span id="stat-solved" class="stat-value text-success">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Flagged</span>
                <span id="stat-flagged" class="stat-value text-warning">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Remaining</span>
                <span id="stat-remaining" class="stat-value">@Model.QuestionList.Count</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-label">Exam Progress</span>
                <span class="progress-percentage" id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="question-slider-card">
            <div class="slider-header">
                <div class="header-left">
                    <span style="color: var(--gray); font-weight: 600;">Question</span>
                    <span id="current-q-num" class="highlight-num">1</span>
                    <span style="color: var(--gray); font-weight: 600;">of</span>
                    <span id="total-q-num" style="font-weight: 700; color: var(--dark);">@Model.QuestionList.Count</span>
                </div>

                <div class="header-right">
                    <button id="btn-flag" class="btn-flag">
                        <span>🚩</span> <span id="flag-text">Flag</span>
                    </button>
                    <span class="badge badge-primary" id="q-type-badge">MCQ</span>
                </div>
            </div>

            <div class="slider-body">
                <h3 id="question-text" class="question-text">Loading...</h3>
                <div id="options-container" class="options-grid"></div>
            </div>

            <div class="slider-footer">
                <button id="btn-prev" class="btn-nav btn-outline">← Previous</button>
                <button id="btn-next" class="btn-nav btn-primary">Next →</button>
            </div>
        </div>

        <div class="question-navigator">
            <div class="navigator-title">Quick Navigation</div>
            <div class="navigator-grid" id="navigator-grid"></div>
        </div>
    </div>

    <div class="modal" id="submit-modal">
        <div class="modal-content">
            <h2 class="modal-header">Review Your Answers</h2>
            <div class="modal-body">
                <div class="review-summary">
                    <div class="review-summary-item">
                        <div class="review-summary-value text-success" id="review-answered">0</div>
                        <div class="review-summary-label">Answered</div>
                    </div>
                    <div class="review-summary-item">
                        <div class="review-summary-value text-warning" id="review-flagged">0</div>
                        <div class="review-summary-label">Flagged</div>
                    </div>
                    <div class="review-summary-item">
                        <div class="review-summary-value" id="review-unanswered">0</div>
                        <div class="review-summary-label">Unanswered</div>
                    </div>
                </div>
                <div id="review-questions-container"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" id="btn-cancel-submit">Back to Exam</button>
                <button class="btn-modal btn-submit" id="btn-confirm-submit">Submit Exam</button>
            </div>
        </div>
    </div>

    <form id="exam-form" action="/Exam/SubmitExam" method="post" style="display:none;">
        <input type="hidden" name="ExamId" value="@Model.id" />
        <input type="hidden" name="StudentId" value="@ViewBag.StudentId" />
        <input type="hidden" name="AnswersJson" id="answers-input" />
    </form>
    <script>
        // FIXED: Use the pre-serialized JSON from C# which handles CamelCase
        var examData = @Html.Raw(modelJson);
        var examDuration = @Model.Duration * 60; // Convert to seconds
        var examId = @ViewBag.ExamId;
        var studentId = @ViewBag.StudentId;

        // Transform the data structure for the exam
        var examQuestions = examData.questionList.map(function(q, index) {
            var questionType = (q.type || 'MCQ').toLowerCase();

            if (questionType === 'tf' || questionType === 'truefalse' || questionType === 't/f') {
                return {
                    id: q.questionId,
                    text: q.text,
                    type: 'True/False',
                    options: ['True', 'False'],
                    choices: (q.choices && q.choices.length > 0)
                             ? q.choices
                             : [{choiceId: -1, text: 'True'}, {choiceId: -2, text: 'False'}],
                    userAnswer: null,
                    userAnswerChoiceId: null,
                    isFlagged: false,
                    isTrueFalse: true
                };
            } else {
                return {
                    id: q.questionId,
                    text: q.text,
                    type: questionType.toUpperCase(),
                    options: q.choices.map(c => c.text),
                    choices: q.choices,
                    userAnswer: null,
                    userAnswerChoiceId: null,
                    isFlagged: false,
                    isTrueFalse: false
                };
            }
        });

        var currentIndex = 0;
        var timerSeconds = examDuration;
        var timerInterval = null;
        var isSubmitting = false; // Prevent double submission

        function init() {
            // ✅ FIXED: Check if there are any questions before proceeding
            if (!examQuestions || examQuestions.length === 0) {
                console.warn('There are no questions in this exam.');
                return;
            }

            loadQuestion(currentIndex);
            updateDashboardStats();
            createNavigator();
            startTimer();

            document.getElementById('btn-prev').addEventListener('click', prevQuestion);
            document.getElementById('btn-next').addEventListener('click', nextQuestion);
            document.getElementById('btn-flag').addEventListener('click', toggleFlag);
            document.getElementById('btn-cancel-submit').addEventListener('click', closeModal);
            document.getElementById('btn-confirm-submit').addEventListener('click', confirmSubmit);

            // ✅ Prevent page reload/close during exam
            window.addEventListener('beforeunload', function (e) {
                if (!isSubmitting) {
                    e.preventDefault();
                    e.returnValue = 'You have an ongoing exam. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });
        }

        function loadQuestion(index) {
            var q = examQuestions[index];
            document.getElementById('current-q-num').innerText = index + 1;
            document.getElementById('total-q-num').innerText = examQuestions.length;
            document.getElementById('q-type-badge').innerText = q.type;
            document.getElementById('question-text').innerText = q.text;

            var container = document.getElementById('options-container');
            container.innerHTML = '';

            if (q.isTrueFalse) {
                container.className = 'tf-options';
            } else {
                container.className = 'options-grid';
            }

            for (var i = 0; i < q.options.length; i++) {
                var optionDiv = document.createElement('div');
                optionDiv.className = 'option-card';

                if (q.userAnswer === i) {
                    optionDiv.classList.add('selected');
                }

                var markerChar = String.fromCharCode(65 + i);
                optionDiv.innerHTML = '<div class="option-marker">' + markerChar + '</div><div class="option-text">' + escapeHtml(q.options[i]) + '</div>';

                optionDiv.setAttribute('data-option', i);
                optionDiv.addEventListener('click', function () {
                    selectOption(parseInt(this.getAttribute('data-option')));
                });

                container.appendChild(optionDiv);
            }

            var flagBtn = document.getElementById('btn-flag');
            var flagText = document.getElementById('flag-text');
            if (q.isFlagged) {
                flagBtn.classList.add('active');
                flagText.innerText = 'Flagged';
            } else {
                flagBtn.classList.remove('active');
                flagText.innerText = 'Flag';
            }

            document.getElementById('btn-prev').disabled = index === 0;
            var nextBtn = document.getElementById('btn-next');
            if (index === examQuestions.length - 1) {
                nextBtn.innerHTML = 'Finish ✓';
            } else {
                nextBtn.innerHTML = 'Next →';
            }

            updateNavigator();
        }

        function selectOption(optionIndex) {
            var currentQ = examQuestions[currentIndex];

            if (currentQ.userAnswer === optionIndex) {
                currentQ.userAnswer = null;
                currentQ.userAnswerChoiceId = null;
            } else {
                currentQ.userAnswer = optionIndex;
                if (currentQ.choices && currentQ.choices[optionIndex]) {
                     currentQ.userAnswerChoiceId = currentQ.choices[optionIndex].choiceId;
                }
            }

            loadQuestion(currentIndex);
            updateDashboardStats();
        }

        function toggleFlag() {
            examQuestions[currentIndex].isFlagged = !examQuestions[currentIndex].isFlagged;
            loadQuestion(currentIndex);
            updateDashboardStats();
        }

        function updateDashboardStats() {
            var total = examQuestions.length;
            var solvedCount = 0;
            var flaggedCount = 0;

            for (var i = 0; i < examQuestions.length; i++) {
                if (examQuestions[i].userAnswer !== null) solvedCount++;
                if (examQuestions[i].isFlagged) flaggedCount++;
            }

            var remaining = total - solvedCount;
            var percentage = total > 0 ? Math.round((solvedCount / total) * 100) : 0;

            document.getElementById('stat-solved').innerText = solvedCount;
            document.getElementById('stat-flagged').innerText = flaggedCount;
            document.getElementById('stat-remaining').innerText = remaining;
            document.getElementById('progress-percentage').innerText = percentage + '%';
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function nextQuestion() {
            if (currentIndex < examQuestions.length - 1) {
                currentIndex++;
                loadQuestion(currentIndex);
            } else {
                showSubmitModal();
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                loadQuestion(currentIndex);
            }
        }

        function goToQuestion(index) {
            currentIndex = index;
            loadQuestion(currentIndex);
        }

        function createNavigator() {
            var container = document.getElementById('navigator-grid');
            container.innerHTML = '';

            for (var i = 0; i < examQuestions.length; i++) {
                var dot = document.createElement('button');
                dot.className = 'nav-dot';
                dot.innerText = i + 1;
                dot.setAttribute('data-index', i);
                dot.addEventListener('click', function () {
                    goToQuestion(parseInt(this.getAttribute('data-index')));
                });
                container.appendChild(dot);
            }
        }

        function updateNavigator() {
            var dots = document.querySelectorAll('.nav-dot');
            for (var i = 0; i < dots.length; i++) {
                dots[i].classList.remove('active', 'answered', 'flagged');

                if (i === currentIndex) {
                    dots[i].classList.add('active');
                }

                if (examQuestions[i].userAnswer !== null) {
                    dots[i].classList.add('answered');
                }

                if (examQuestions[i].isFlagged) {
                    dots[i].classList.add('flagged');
                }
            }
        }

        function startTimer() {
            timerInterval = setInterval(function () {
                if (timerSeconds > 0) {
                    timerSeconds--;
                    var minutes = Math.floor(timerSeconds / 60);
                    var seconds = timerSeconds % 60;

                    var timerElement = document.getElementById('timer');
                    timerElement.innerText =
                        (minutes < 10 ? '0' : '') + minutes + ':' +
                        (seconds < 10 ? '0' : '') + seconds;

                    // ✅ Warning when 5 minutes left
                    if (timerSeconds === 300) {
                        timerElement.style.color = '#f59e0b'; // Orange warning
                        alert('⚠️ Warning: Only 5 minutes remaining!');
                    }

                    // ✅ Critical warning when 1 minute left
                    if (timerSeconds === 60) {
                        timerElement.style.color = '#ef4444'; // Red critical
                        alert('🚨 Critical: Only 1 minute remaining!');
                    }

                } else {
                    // ✅ TIME IS UP - AUTO SUBMIT
                    clearInterval(timerInterval);
                    autoSubmitExam();
                }
            }, 1000);
        }

        // ✅ AUTO SUBMIT WHEN TIME IS UP
              function autoSubmitExam() {
            if (isSubmitting) return;
            isSubmitting = true;

            alert('⏰ Time is up! Your exam is being submitted automatically...');

            // Prepare answers data matching C# SubmittedAnswer class EXACTLY
            var answers = examQuestions.map(function(q) {
                return {
                    QuestionId: q.id,

                    // Match C# property: public int? ChoiceId
                    ChoiceId: q.userAnswerChoiceId,

                    // Match C# property: public bool? TrueFalseAnswer
                    // If isTrueFalse is true: index 0 is "True", index 1 is "False"
                    TrueFalseAnswer: q.isTrueFalse && q.userAnswer !== null
                                     ? (q.userAnswer === 0)
                                     : null
                };
            });

            document.getElementById('answers-input').value = JSON.stringify(answers);
            document.getElementById('exam-form').submit();
        }


        function showSubmitModal() {
            var solvedCount = 0;
            var flaggedCount = 0;

            for (var i = 0; i < examQuestions.length; i++) {
                if (examQuestions[i].userAnswer !== null) solvedCount++;
                if (examQuestions[i].isFlagged) flaggedCount++;
            }

            var unanswered = examQuestions.length - solvedCount;

            document.getElementById('review-answered').innerText = solvedCount;
            document.getElementById('review-flagged').innerText = flaggedCount;
            document.getElementById('review-unanswered').innerText = unanswered;

            var reviewContainer = document.getElementById('review-questions-container');
            reviewContainer.innerHTML = '';

            for (var i = 0; i < examQuestions.length; i++) {
                var q = examQuestions[i];

                var questionDiv = document.createElement('div');
                questionDiv.className = 'review-question';

                var headerDiv = document.createElement('div');
                headerDiv.className = 'review-question-header';

                var numberSpan = document.createElement('span');
                numberSpan.className = 'review-question-number';
                numberSpan.innerText = 'Question ' + (i + 1);

                var typeSpan = document.createElement('span');
                typeSpan.className = 'review-question-type';
                typeSpan.innerText = q.type;

                headerDiv.appendChild(numberSpan);
                headerDiv.appendChild(typeSpan);

                var textDiv = document.createElement('div');
                textDiv.className = 'review-question-text';
                textDiv.innerText = q.text;

                var answerDiv = document.createElement('div');
                answerDiv.className = 'review-answer';

                var labelSpan = document.createElement('span');
                labelSpan.className = 'review-answer-label';
                labelSpan.innerText = 'Your Answer:';

                var valueSpan = document.createElement('span');
                if (q.userAnswer !== null) {
                    valueSpan.className = 'review-answer-value';
                    var answerLetter = String.fromCharCode(65 + q.userAnswer);
                    valueSpan.innerText = answerLetter + ': ' + q.options[q.userAnswer];
                } else {
                    valueSpan.className = 'review-answer-none';
                    valueSpan.innerText = 'Not Answered';
                }

                answerDiv.appendChild(labelSpan);
                answerDiv.appendChild(valueSpan);

                questionDiv.appendChild(headerDiv);
                questionDiv.appendChild(textDiv);
                questionDiv.appendChild(answerDiv);

                reviewContainer.appendChild(questionDiv);
            }

            document.getElementById('submit-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('submit-modal').classList.remove('active');
        }
        // ✅ CONFIRM SUBMIT (Fixed Data Mapping)
        function confirmSubmit() {
            if (isSubmitting) return;
            isSubmitting = true;

            closeModal();

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Prepare answers data matching C# SubmittedAnswer class EXACTLY
            var answers = examQuestions.map(function(q) {
                return {
                    QuestionId: q.id,

                    // Match C# property: public int? ChoiceId
                    ChoiceId: q.userAnswerChoiceId,

                    // Match C# property: public bool? TrueFalseAnswer
                    TrueFalseAnswer: q.isTrueFalse && q.userAnswer !== null
                                     ? (q.userAnswer === 0)
                                     : null
                };
            });

            document.getElementById('answers-input').value = JSON.stringify(answers);
            document.getElementById('exam-form').submit();
        }

        function escapeHtml(text) {
            if (!text) return '';
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        init();
    </script>
</body>
</html>